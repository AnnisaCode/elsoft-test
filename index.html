<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Informasi Penjualan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#1E40AF',
                        success: '#10B981',
                        danger: '#EF4444',
                        warning: '#F59E0B',
                        dark: '#1F2937'
                    }
                }
            }
        }
    </script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading {
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Notification Toast -->
    <div id="toast" class="fixed top-4 right-4 z-50 hidden">
        <div class="bg-white shadow-lg rounded-lg p-4 max-w-sm border-l-4" id="toast-content">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div id="toast-icon"></div>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900" id="toast-message"></p>
                </div>
                <div class="ml-auto pl-3">
                    <button onclick="hideToast()" class="text-gray-400 hover:text-gray-600">
                        <span class="sr-only">Close</span>
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav id="navbar" class="bg-white shadow-sm border-b hidden">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <h1 class="text-xl font-bold text-gray-900">SIS - Elsoft</h1>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="#item"
                            class="nav-link border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                            Items
                        </a>
                        <a href="#transaction"
                            class="nav-link border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                            Transactions
                        </a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600" id="user-info"></span>
                    <button onclick="logout()"
                        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                        Logout
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile menu -->
        <div class="sm:hidden">
            <div class="pt-2 pb-3 space-y-1">
                <a href="#item"
                    class="nav-link-mobile bg-transparent text-gray-500 hover:bg-gray-50 hover:text-gray-700 block px-3 py-2 text-base font-medium">Items</a>
                <a href="#transaction"
                    class="nav-link-mobile bg-transparent text-gray-500 hover:bg-gray-50 hover:text-gray-700 block px-3 py-2 text-base font-medium">Transactions</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content" class="fade-in">
        <!-- Login Page -->
        <div id="login-page" class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
            <div class="max-w-md w-full space-y-8">
                <div>
                    <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                        Sistem Informasi Penjualan
                    </h2>
                    <p class="mt-2 text-center text-sm text-gray-600">
                        Silakan login untuk melanjutkan
                    </p>
                </div>
                <form id="login-form" class="mt-8 space-y-6">
                    <div class="rounded-md shadow-sm -space-y-px">
                        <div>
                            <label for="domain" class="sr-only">Domain</label>
                            <input id="domain" name="domain" type="text" required
                                class="relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-primary focus:border-primary focus:z-10 sm:text-sm"
                                placeholder="Domain" value="testcase">
                        </div>
                        <div>
                            <label for="username" class="sr-only">Username</label>
                            <input id="username" name="username" type="text" required
                                class="relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-primary focus:border-primary focus:z-10 sm:text-sm"
                                placeholder="Username" value="testcase">
                        </div>
                        <div>
                            <label for="password" class="sr-only">Password</label>
                            <input id="password" name="password" type="password" required
                                class="relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-primary focus:border-primary focus:z-10 sm:text-sm"
                                placeholder="Password" value="testcase123">
                        </div>
                    </div>

                    <div>
                        <button type="submit" id="login-btn"
                            class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                            <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                                <svg class="h-5 w-5 text-primary-light group-hover:text-primary-dark"
                                    fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                                        clip-rule="evenodd"></path>
                                </svg>
                            </span>
                            Masuk
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Items Page -->
        <div id="item-page" class="hidden">
            <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                <div class="px-4 py-6 sm:px-0">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold text-gray-900">Master Item</h1>
                        <button onclick="showItemModal()"
                            class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-md text-sm font-medium">
                            + Tambah Item
                        </button>
                    </div>

                    <!-- Search and Filter -->
                    <div class="mb-4 flex flex-col sm:flex-row gap-4">
                        <div class="flex-1">
                            <input type="text" id="item-search" placeholder="Cari item..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                        </div>
                        <button onclick="loadItems()"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                            Refresh
                        </button>
                    </div>

                    <!-- Items Table -->
                    <div class="bg-white shadow overflow-hidden sm:rounded-md">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Nama Item</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Kode</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Kategori</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Harga</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="items-table-body" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                            <div class="flex justify-center items-center">
                                                <div
                                                    class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary">
                                                </div>
                                                <span class="ml-2">Memuat data...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transactions Page -->
        <div id="transaction-page" class="hidden">
            <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                <div class="px-4 py-6 sm:px-0">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold text-gray-900">Stock Issue Transactions</h1>
                        <button onclick="showTransactionModal()"
                            class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-md text-sm font-medium">
                            + Tambah Transaksi
                        </button>
                    </div>

                    <!-- Search and Filter -->
                    <div class="mb-4 flex flex-col sm:flex-row gap-4">
                        <div class="flex-1">
                            <input type="text" id="transaction-search" placeholder="Cari transaksi..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                        </div>
                        <button onclick="loadTransactions()"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                            Refresh
                        </button>
                    </div>

                    <!-- Transactions Table -->
                    <div class="bg-white shadow overflow-hidden sm:rounded-md">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            No. Dokumen</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Tanggal</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Customer</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Total</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Status</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="transactions-table-body" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                            <div class="flex justify-center items-center">
                                                <div
                                                    class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary">
                                                </div>
                                                <span class="ml-2">Memuat data...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Item Modal -->
    <div id="item-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-40">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4" id="item-modal-title">Tambah Item</h3>
                <form id="item-form">
                    <input type="hidden" id="item-oid">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Nama Item</label>
                        <input type="text" id="item-name" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Kode Item</label>
                        <input type="text" id="item-code" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Kategori</label>
                        <input type="text" id="item-category"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Harga</label>
                        <input type="number" id="item-price" step="0.01"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="hideItemModal()"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md text-sm font-medium">
                            Batal
                        </button>
                        <button type="submit"
                            class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-md text-sm font-medium">
                            Simpan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transaction-modal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-40">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4" id="transaction-modal-title">Tambah Transaksi</h3>
                <form id="transaction-form">
                    <input type="hidden" id="transaction-oid">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">No. Dokumen</label>
                        <input type="text" id="transaction-docno" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Tanggal</label>
                        <input type="date" id="transaction-date" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Customer</label>
                        <input type="text" id="transaction-customer"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Keterangan</label>
                        <textarea id="transaction-description"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-primary focus:border-primary"
                            rows="3"></textarea>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="hideTransactionModal()"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md text-sm font-medium">
                            Batal
                        </button>
                        <button type="submit"
                            class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-md text-sm font-medium">
                            Simpan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentUser = null;
        let authToken = null;
        let currentItems = [];
        let currentTransactions = [];

        // API Configuration
        const API_CONFIG = {
            AUTH_BASE: 'https://api-core.elsoft.id/portal/api',
            APP_BASE: 'https://api-app.elsoft.id/admin/api/v1'
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', function () {
            // Check if user is already logged in
            authToken = localStorage.getItem('authToken');
            currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');

            if (authToken && currentUser) {
                showNavbar();
                navigateToPage('item');
            } else {
                navigateToPage('login');
            }

            // Setup event listeners
            setupEventListeners();

            // Handle initial route
            handleRouteChange();
        });

        // Event Listeners Setup
        function setupEventListeners() {
            // Login form
            document.getElementById('login-form').addEventListener('submit', handleLogin);

            // Item form
            document.getElementById('item-form').addEventListener('submit', handleItemSubmit);

            // Transaction form
            document.getElementById('transaction-form').addEventListener('submit', handleTransactionSubmit);

            // Search functionality
            document.getElementById('item-search').addEventListener('input', filterItems);
            document.getElementById('transaction-search').addEventListener('input', filterTransactions);

            // Hash change for routing
            window.addEventListener('hashchange', handleRouteChange);

            // Navigation links
            document.querySelectorAll('.nav-link, .nav-link-mobile').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const page = this.getAttribute('href').substring(1);
                    navigateToPage(page);
                });
            });
        }

        // Routing Functions
        function handleRouteChange() {
            const hash = window.location.hash.substring(1) || 'login';
            navigateToPage(hash);
        }

        function navigateToPage(page) {
            // Hide all pages
            document.querySelectorAll('#main-content > div').forEach(div => {
                div.classList.add('hidden');
            });

            // Update navigation active state
            document.querySelectorAll('.nav-link, .nav-link-mobile').forEach(link => {
                link.classList.remove('border-primary', 'text-primary', 'bg-gray-100');
                link.classList.add('border-transparent', 'text-gray-500');
            });

            // Show requested page
            const pageElement = document.getElementById(`${page}-page`);
            if (pageElement) {
                pageElement.classList.remove('hidden');
                pageElement.classList.add('fade-in');

                // Activate navigation link
                const activeLink = document.querySelector(`[href="#${page}"]`);
                if (activeLink) {
                    activeLink.classList.remove('border-transparent', 'text-gray-500');
                    activeLink.classList.add('border-primary', 'text-primary');
                    if (activeLink.classList.contains('nav-link-mobile')) {
                        activeLink.classList.add('bg-gray-100');
                    }
                }

                // Load data for specific pages
                if (page === 'item' && authToken) {
                    loadItems();
                } else if (page === 'transaction' && authToken) {
                    loadTransactions();
                }
            }

            // Update URL hash
            if (window.location.hash !== `#${page}`) {
                window.location.hash = page;
            }
        }

        // Authentication Functions
        async function handleLogin(e) {
            e.preventDefault();

            const loginBtn = document.getElementById('login-btn');
            const originalText = loginBtn.innerHTML;

            try {
                loginBtn.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>';
                loginBtn.disabled = true;

                const formData = new FormData(e.target);
                const loginData = {
                    domain: formData.get('domain'),
                    username: formData.get('username'),
                    password: formData.get('password')
                };

                const response = await fetch(`${API_CONFIG.AUTH_BASE}/auth/signin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(loginData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    authToken = result.data.token;
                    currentUser = result.data.user;

                    // Save to localStorage
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));

                    showToast('Login berhasil!', 'success');
                    showNavbar();
                    navigateToPage('item');
                } else {
                    throw new Error(result.message || 'Login gagal');
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('Login gagal: ' + error.message, 'error');
            } finally {
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            authToken = null;
            currentUser = null;
            hideNavbar();
            navigateToPage('login');
            showToast('Logout berhasil', 'success');
        }

        function showNavbar() {
            document.getElementById('navbar').classList.remove('hidden');
            if (currentUser) {
                document.getElementById('user-info').textContent = `Welcome, ${currentUser.username}`;
            }
        }

        function hideNavbar() {
            document.getElementById('navbar').classList.add('hidden');
        }

        // API Helper Functions
        async function apiRequest(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                }
            };

            const mergedOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            };

            try {
                const response = await fetch(url, mergedOptions);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'API request failed');
                }

                return data;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Items Management
        async function loadItems() {
            try {
                const tbody = document.getElementById('items-table-body');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                            <div class="flex justify-center items-center">
                                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
                                <span class="ml-2">Memuat data...</span>
                            </div>
                        </td>
                    </tr>
                `;

                const response = await apiRequest(`${API_CONFIG.APP_BASE}/item/list`);

                if (response.success && response.data) {
                    currentItems = response.data;
                    renderItems(currentItems);
                } else {
                    throw new Error(response.message || 'Failed to load items');
                }
            } catch (error) {
                console.error('Load items error:', error);
                showToast('Gagal memuat data item: ' + error.message, 'error');
                document.getElementById('items-table-body').innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                            Gagal memuat data. <button onclick="loadItems()" class="text-primary hover:underline">Coba lagi</button>
                        </td>
                    </tr>
                `;
            }
        }

        function renderItems(items) {
            const tbody = document.getElementById('items-table-body');

            if (!items || items.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                            Tidak ada data item
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = items.map(item => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.code || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.category || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(item.price)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editItem('${item.Oid}')" class="text-primary hover:text-secondary mr-2">Edit</button>
                        <button onclick="deleteItem('${item.Oid}')" class="text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterItems() {
            const searchTerm = document.getElementById('item-search').value.toLowerCase();
            const filteredItems = currentItems.filter(item =>
                (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                (item.code && item.code.toLowerCase().includes(searchTerm)) ||
                (item.category && item.category.toLowerCase().includes(searchTerm))
            );
            renderItems(filteredItems);
        }

        function showItemModal(item = null) {
            const modal = document.getElementById('item-modal');
            const title = document.getElementById('item-modal-title');

            if (item) {
                title.textContent = 'Edit Item';
                document.getElementById('item-oid').value = item.Oid;
                document.getElementById('item-name').value = item.name || '';
                document.getElementById('item-code').value = item.code || '';
                document.getElementById('item-category').value = item.category || '';
                document.getElementById('item-price').value = item.price || '';
            } else {
                title.textContent = 'Tambah Item';
                document.getElementById('item-form').reset();
                document.getElementById('item-oid').value = '';
            }

            modal.classList.remove('hidden');
        }

        function hideItemModal() {
            document.getElementById('item-modal').classList.add('hidden');
        }

        async function handleItemSubmit(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const itemData = {
                name: formData.get('item-name') || document.getElementById('item-name').value,
                code: formData.get('item-code') || document.getElementById('item-code').value,
                category: formData.get('item-category') || document.getElementById('item-category').value,
                price: parseFloat(formData.get('item-price') || document.getElementById('item-price').value) || 0
            };

            const oid = document.getElementById('item-oid').value;

            try {
                let response;
                if (oid) {
                    // Edit existing item
                    response = await apiRequest(`${API_CONFIG.APP_BASE}/item/save?Oid=${oid}`, {
                        method: 'POST',
                        body: JSON.stringify(itemData)
                    });
                } else {
                    // Create new item
                    response = await apiRequest(`${API_CONFIG.APP_BASE}/item`, {
                        method: 'POST',
                        body: JSON.stringify(itemData)
                    });
                }

                if (response.success) {
                    showToast(oid ? 'Item berhasil diperbarui' : 'Item berhasil ditambahkan', 'success');
                    hideItemModal();
                    loadItems();
                } else {
                    throw new Error(response.message || 'Failed to save item');
                }
            } catch (error) {
                console.error('Save item error:', error);
                showToast('Gagal menyimpan item: ' + error.message, 'error');
            }
        }

        async function editItem(oid) {
            const item = currentItems.find(i => i.Oid === oid);
            if (item) {
                showItemModal(item);
            } else {
                showToast('Item tidak ditemukan', 'error');
            }
        }

        async function deleteItem(oid) {
            if (!confirm('Yakin ingin menghapus item ini?')) {
                return;
            }

            try {
                const response = await apiRequest(`${API_CONFIG.APP_BASE}/data/item/delete?Oid=${oid}`, {
                    method: 'DELETE'
                });

                if (response.success) {
                    showToast('Item berhasil dihapus', 'success');
                    loadItems();
                } else {
                    throw new Error(response.message || 'Failed to delete item');
                }
            } catch (error) {
                console.error('Delete item error:', error);
                showToast('Gagal menghapus item: ' + error.message, 'error');
            }
        }

        // Transactions Management
        async function loadTransactions() {
            try {
                const tbody = document.getElementById('transactions-table-body');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            <div class="flex justify-center items-center">
                                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
                                <span class="ml-2">Memuat data...</span>
                            </div>
                        </td>
                    </tr>
                `;

                const response = await apiRequest(`${API_CONFIG.APP_BASE}/stockissue/list`);

                if (response.success && response.data) {
                    currentTransactions = response.data;
                    renderTransactions(currentTransactions);
                } else {
                    throw new Error(response.message || 'Failed to load transactions');
                }
            } catch (error) {
                console.error('Load transactions error:', error);
                showToast('Gagal memuat data transaksi: ' + error.message, 'error');
                document.getElementById('transactions-table-body').innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            Gagal memuat data. <button onclick="loadTransactions()" class="text-primary hover:underline">Coba lagi</button>
                        </td>
                    </tr>
                `;
            }
        }

        function renderTransactions(transactions) {
            const tbody = document.getElementById('transactions-table-body');

            if (!transactions || transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            Tidak ada data transaksi
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = transactions.map(transaction => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.docno || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(transaction.date)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.customer || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(transaction.total)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusClass(transaction.status)}">
                            ${transaction.status || 'Draft'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editTransaction('${transaction.Oid}')" class="text-primary hover:text-secondary mr-2">Edit</button>
                        <button onclick="deleteTransaction('${transaction.Oid}')" class="text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterTransactions() {
            const searchTerm = document.getElementById('transaction-search').value.toLowerCase();
            const filteredTransactions = currentTransactions.filter(transaction =>
                (transaction.docno && transaction.docno.toLowerCase().includes(searchTerm)) ||
                (transaction.customer && transaction.customer.toLowerCase().includes(searchTerm)) ||
                (transaction.status && transaction.status.toLowerCase().includes(searchTerm))
            );
            renderTransactions(filteredTransactions);
        }

        function showTransactionModal(transaction = null) {
            const modal = document.getElementById('transaction-modal');
            const title = document.getElementById('transaction-modal-title');

            if (transaction) {
                title.textContent = 'Edit Transaksi';
                document.getElementById('transaction-oid').value = transaction.Oid;
                document.getElementById('transaction-docno').value = transaction.docno || '';
                document.getElementById('transaction-date').value = transaction.date ? transaction.date.split('T')[0] : '';
                document.getElementById('transaction-customer').value = transaction.customer || '';
                document.getElementById('transaction-description').value = transaction.description || '';
            } else {
                title.textContent = 'Tambah Transaksi';
                document.getElementById('transaction-form').reset();
                document.getElementById('transaction-oid').value = '';
                // Set default date to today
                document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
            }

            modal.classList.remove('hidden');
        }

        function hideTransactionModal() {
            document.getElementById('transaction-modal').classList.add('hidden');
        }

        async function handleTransactionSubmit(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const transactionData = {
                docno: formData.get('transaction-docno') || document.getElementById('transaction-docno').value,
                date: formData.get('transaction-date') || document.getElementById('transaction-date').value,
                customer: formData.get('transaction-customer') || document.getElementById('transaction-customer').value,
                description: formData.get('transaction-description') || document.getElementById('transaction-description').value
            };

            const oid = document.getElementById('transaction-oid').value;

            try {
                let response;
                if (oid) {
                    // Edit existing transaction
                    response = await apiRequest(`${API_CONFIG.APP_BASE}/stockissue/${oid}`, {
                        method: 'POST',
                        body: JSON.stringify(transactionData)
                    });
                } else {
                    // Create new transaction
                    response = await apiRequest(`${API_CONFIG.APP_BASE}/stockissue`, {
                        method: 'POST',
                        body: JSON.stringify(transactionData)
                    });
                }

                if (response.success) {
                    showToast(oid ? 'Transaksi berhasil diperbarui' : 'Transaksi berhasil ditambahkan', 'success');
                    hideTransactionModal();
                    loadTransactions();
                } else {
                    throw new Error(response.message || 'Failed to save transaction');
                }
            } catch (error) {
                console.error('Save transaction error:', error);
                showToast('Gagal menyimpan transaksi: ' + error.message, 'error');
            }
        }

        async function editTransaction(oid) {
            try {
                // Try to get transaction details first
                const response = await apiRequest(`${API_CONFIG.APP_BASE}/stockissue/${oid}`);
                if (response.success && response.data) {
                    showTransactionModal(response.data);
                } else {
                    // Fallback to current transactions list
                    const transaction = currentTransactions.find(t => t.Oid === oid);
                    if (transaction) {
                        showTransactionModal(transaction);
                    } else {
                        showToast('Transaksi tidak ditemukan', 'error');
                    }
                }
            } catch (error) {
                console.error('Edit transaction error:', error);
                // Fallback to current transactions list
                const transaction = currentTransactions.find(t => t.Oid === oid);
                if (transaction) {
                    showTransactionModal(transaction);
                } else {
                    showToast('Transaksi tidak ditemukan', 'error');
                }
            }
        }

        async function deleteTransaction(oid) {
            if (!confirm('Yakin ingin menghapus transaksi ini?')) {
                return;
            }

            try {
                const response = await apiRequest(`${API_CONFIG.APP_BASE}/stockissue/${oid}`, {
                    method: 'DELETE'
                });

                if (response.success) {
                    showToast('Transaksi berhasil dihapus', 'success');
                    loadTransactions();
                } else {
                    throw new Error(response.message || 'Failed to delete transaction');
                }
            } catch (error) {
                console.error('Delete transaction error:', error);
                showToast('Gagal menghapus transaksi: ' + error.message, 'error');
            }
        }

        // Utility Functions
        function formatCurrency(amount) {
            if (!amount && amount !== 0) return 'Rp 0';
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('id-ID', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (error) {
                return dateString;
            }
        }

        function getStatusClass(status) {
            switch (status?.toLowerCase()) {
                case 'completed':
                case 'complete':
                    return 'bg-green-100 text-green-800';
                case 'pending':
                    return 'bg-yellow-100 text-yellow-800';
                case 'cancelled':
                case 'canceled':
                    return 'bg-red-100 text-red-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        // Toast Notification Functions
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastContent = document.getElementById('toast-content');
            const toastIcon = document.getElementById('toast-icon');
            const toastMessage = document.getElementById('toast-message');

            // Set message
            toastMessage.textContent = message;

            // Set icon and border color based on type
            let iconHtml = '';
            let borderClass = '';

            switch (type) {
                case 'success':
                    iconHtml = '<svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
                    borderClass = 'border-green-400';
                    break;
                case 'error':
                    iconHtml = '<svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>';
                    borderClass = 'border-red-400';
                    break;
                case 'warning':
                    iconHtml = '<svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>';
                    borderClass = 'border-yellow-400';
                    break;
                default:
                    iconHtml = '<svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>';
                    borderClass = 'border-blue-400';
            }

            toastIcon.innerHTML = iconHtml;
            toastContent.className = `bg-white shadow-lg rounded-lg p-4 max-w-sm border-l-4 ${borderClass}`;

            // Show toast
            toast.classList.remove('hidden');

            // Auto hide after 5 seconds
            setTimeout(() => {
                hideToast();
            }, 5000);
        }

        function hideToast() {
            document.getElementById('toast').classList.add('hidden');
        }

        // Close modals when clicking outside
        window.onclick = function (event) {
            const itemModal = document.getElementById('item-modal');
            const transactionModal = document.getElementById('transaction-modal');

            if (event.target === itemModal) {
                hideItemModal();
            }
            if (event.target === transactionModal) {
                hideTransactionModal();
            }
        }
    </script>
</body>

</html>="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.name || '-'}</td>
<td class